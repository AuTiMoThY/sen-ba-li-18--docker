# 如何遷移到新專案

本文件說明如何將現有的 Docker 配置遷移到新的專案中。

## 遷移前準備

### 1. 確認新專案類型

在開始遷移前，確認新專案的類型：
- ✅ Vue 3 + Vite + TypeScript（當前配置）
- ⚠️ Vue 3 + Vite（無 TypeScript）
- ⚠️ React + Vite
- ⚠️ 其他框架（需要調整配置）

### 2. 確認套件管理器

確認新專案使用的套件管理器：
- `pnpm`（當前配置）
- `npm`
- `yarn`

### 3. 確認開發伺服器端口

確認新專案的開發伺服器端口：
- `5173`（Vite 預設，當前配置）
- `3000`（常見）
- 其他自訂端口

## 遷移步驟

### 步驟一：複製必要檔案

將以下檔案從現有專案複製到新專案根目錄：

```
✅ Dockerfile
✅ compose.yaml
✅ .dockerignore
```

**注意**：不要直接複製，需要根據新專案進行調整。

### 步驟二：調整 Dockerfile

根據新專案類型調整 `Dockerfile`：

#### 2.1 調整 Node.js 版本

```dockerfile
# 根據專案需求調整版本
FROM node:20-alpine AS deps
# 或
FROM node:18-alpine AS deps
```

#### 2.2 調整套件管理器

**如果使用 npm：**
```dockerfile
# 移除 pnpm 安裝
# RUN npm install -g pnpm@10.24.0

# 修改安裝命令
RUN npm ci  # 或 npm install --frozen-lockfile

# 修改執行命令
CMD ["npm", "run", "dev"]
```

**如果使用 yarn：**
```dockerfile
# 安裝 yarn（如果需要特定版本）
RUN npm install -g yarn@1.22.19

# 修改安裝命令
RUN yarn install --frozen-lockfile

# 修改執行命令
CMD ["yarn", "dev"]
```

**如果使用 pnpm（保持不變）：**
```dockerfile
RUN npm install -g pnpm@10.24.0
RUN pnpm install --frozen-lockfile
CMD ["pnpm", "dev"]
```

#### 2.3 調整鎖定檔案名稱

根據套件管理器調整：

```dockerfile
# pnpm
COPY package.json pnpm-lock.yaml ./

# npm
COPY package.json package-lock.json ./

# yarn
COPY package.json yarn.lock ./
```

#### 2.4 調整端口號

如果開發伺服器使用不同端口：

```dockerfile
# 例如：使用 3000 端口
EXPOSE 3000
```

### 步驟三：調整 compose.yaml

#### 3.1 修改容器名稱

```yaml
services:
  app:
    container_name: your-new-project-dev  # 改為新專案名稱
```

#### 3.2 調整端口映射

```yaml
ports:
  - "5173:5173"  # 如果端口不同，調整為：主機端口:容器端口
  # 例如：- "3000:3000"
```

#### 3.3 調整 watch 配置

根據新專案的檔案結構調整 `develop.watch`：

```yaml
develop:
  watch:
    # 根據專案結構調整路徑
    - action: sync
      path: ./src
      target: /app/src
    
    # 如果有 public 目錄
    - action: sync
      path: ./public
      target: /app/public
    
    # 根據專案類型調整配置檔案
    - action: sync
      path: ./vite.config.ts  # 或 vite.config.js
      target: /app/vite.config.ts
    
    # TypeScript 專案
    - action: sync
      path: ./tsconfig.json
      target: /app/tsconfig.json
    
    # React 專案可能需要
    # - action: sync
    #   path: ./tsconfig.json
    #   target: /app/tsconfig.json
```

#### 3.4 調整依賴檔案監控

根據套件管理器調整：

```yaml
# pnpm
- action: rebuild
  path: ./pnpm-lock.yaml

# npm
- action: rebuild
  path: ./package-lock.json

# yarn
- action: rebuild
  path: ./yarn.lock
```

### 步驟四：調整 .dockerignore

根據新專案的結構調整 `.dockerignore`：

```dockerignore
# 保持通用排除項目
node_modules
dist
.git
*.log
.env*

# 根據專案類型調整
# TypeScript 專案
*.tsbuildinfo

# React 專案
build

# 其他專案特定檔案
```

### 步驟五：調整 vite.config.ts（如適用）

如果新專案使用 Vite，確保 `vite.config.ts` 包含 Docker 環境的配置：

```typescript
export default defineConfig({
  server: {
    host: "0.0.0.0", // 必須設定，允許 Docker 訪問
    port: 5173, // 根據專案調整
    watch: {
      usePolling: true, // Docker 環境必需
      interval: 1000
    },
    hmr: {
      host: "localhost",
      port: 5173
    }
  }
});
```

## 不同專案類型的遷移指南

### Vue 3 + Vite + TypeScript（當前配置）

✅ 幾乎不需要調整，直接使用即可。

**需要檢查**：
- `package.json` 中的 scripts 是否為 `"dev": "vite"`
- 端口是否為 `5173`
- 是否有 `tsconfig.json` 等 TypeScript 配置檔案

### Vue 3 + Vite（無 TypeScript）

**調整項目**：

1. **Dockerfile**：移除 TypeScript 相關配置檔案監控
2. **compose.yaml**：移除 `tsconfig.*.json` 的 watch 配置
3. **.dockerignore**：移除 TypeScript 相關排除項目

### React + Vite

**調整項目**：

1. **Dockerfile**：
   ```dockerfile
   # 確認構建命令
   RUN npm run build  # 或 pnpm build
   ```

2. **compose.yaml**：
   ```yaml
   # React 通常使用不同的目錄結構
   develop:
     watch:
       - action: sync
         path: ./src
         target: /app/src
       - action: sync
         path: ./public
         target: /app/public
   ```

3. **vite.config.ts**：確保使用 React 插件
   ```typescript
   import react from '@vitejs/plugin-react'
   
   export default defineConfig({
     plugins: [react()],
     // ... 其他配置
   })
   ```

### Next.js

**注意**：Next.js 需要不同的配置，不建議直接使用此配置。

### Nuxt.js

**注意**：Nuxt.js 需要不同的配置，不建議直接使用此配置。

## 遷移檢查清單

在完成遷移後，使用以下檢查清單確認：

- [ ] `Dockerfile` 中的套件管理器與新專案一致
- [ ] `Dockerfile` 中的端口號與新專案一致
- [ ] `compose.yaml` 中的容器名稱已更新
- [ ] `compose.yaml` 中的端口映射正確
- [ ] `compose.yaml` 中的 watch 路徑與新專案結構一致
- [ ] `.dockerignore` 已根據新專案調整
- [ ] `vite.config.ts`（如適用）包含 Docker 環境配置
- [ ] 鎖定檔案名稱與套件管理器一致

## 測試遷移

### 1. 構建映像檔

```bash
docker compose build
```

**預期結果**：構建成功，無錯誤訊息

### 2. 啟動開發環境

```bash
docker compose watch
```

**預期結果**：
- 容器成功啟動
- 開發伺服器運行在正確端口
- 終端顯示 Vite 啟動訊息

### 3. 測試熱重載

1. 修改一個 Vue/React 元件檔案
2. 保存檔案
3. 檢查瀏覽器是否自動重新載入

**預期結果**：檔案變更後，頁面自動更新

### 4. 測試生產構建

```bash
docker compose --profile production build
docker compose --profile production up
```

**預期結果**：
- 構建成功
- 生產容器正常運行
- 可以訪問應用程式

## 常見問題

### 問題 1：構建失敗，找不到鎖定檔案

**原因**：鎖定檔案名稱與套件管理器不匹配

**解決方案**：
- 檢查 `Dockerfile` 中的 `COPY` 指令
- 確認新專案使用的鎖定檔案名稱（`package-lock.json`、`yarn.lock`、`pnpm-lock.yaml`）

### 問題 2：端口已被占用

**原因**：主機端口已被其他服務使用

**解決方案**：
```yaml
ports:
  - "5174:5173"  # 使用不同的主機端口
```

### 問題 3：熱重載不工作

**原因**：檔案監控配置不正確

**解決方案**：
1. 確認 `vite.config.ts` 包含 `usePolling: true`
2. 確認 `compose.yaml` 中的 watch 配置正確
3. 確認使用 `docker compose watch` 而不是 `docker compose up`

### 問題 4：找不到模組或依賴

**原因**：`node_modules` 未正確安裝

**解決方案**：
1. 確認 `volumes` 配置中有 `/app/node_modules` 匿名卷
2. 重新構建映像檔：`docker compose build --no-cache`

### 問題 5：TypeScript 錯誤

**原因**：TypeScript 配置檔案未正確同步

**解決方案**：
1. 確認 `compose.yaml` 中的 watch 包含所有 TypeScript 配置檔案
2. 檢查 `tsconfig.json`、`tsconfig.app.json`、`tsconfig.node.json` 是否存在

## 遷移範例

### 範例 1：從 pnpm 遷移到 npm

**Dockerfile 變更**：
```dockerfile
# 移除
# RUN npm install -g pnpm@10.24.0
# COPY package.json pnpm-lock.yaml ./
# RUN pnpm install --frozen-lockfile

# 改為
COPY package.json package-lock.json ./
RUN npm ci
```

**compose.yaml 變更**：
```yaml
# 移除
# - action: rebuild
#   path: ./pnpm-lock.yaml

# 改為
- action: rebuild
  path: ./package-lock.json
```

### 範例 2：從端口 5173 遷移到 3000

**Dockerfile 變更**：
```dockerfile
EXPOSE 3000
```

**compose.yaml 變更**：
```yaml
ports:
  - "3000:3000"
```

**vite.config.ts 變更**：
```typescript
server: {
  port: 3000,
  hmr: {
    port: 3000
  }
}
```

## 最佳實踐

1. **逐步遷移**：先測試開發環境，再測試生產環境
2. **保留原配置**：在完全確認新配置工作正常前，保留原始配置
3. **版本控制**：將 Docker 相關檔案加入版本控制
4. **文件化**：記錄專案特定的調整，方便未來參考
5. **測試完整流程**：確保開發、構建、生產環境都能正常運作

## 下一步

遷移完成後，建議：

1. 閱讀 [如何在新專案中加入 Docker](./01-如何在新專案中加入-docker.md)
2. 了解 [Dockerfile 和 compose.yaml 說明](./02-dockerfile-和-compose-yaml-說明.md)
3. 了解 [Docker 運作流程](./03-docker-運作流程.md)

## 需要幫助？

如果遷移過程中遇到問題：

1. 檢查 [常見問題](#常見問題) 章節
2. 查看 Docker 容器日誌：`docker compose logs -f app`
3. 檢查構建過程：`docker compose build --progress=plain`
4. 參考 [Docker 官方文件](https://docs.docker.com/)
