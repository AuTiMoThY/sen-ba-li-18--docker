# 區網連線問題診斷步驟

## 步驟 1：檢查容器狀態

執行以下命令檢查容器是否正在運行：

```bash
docker ps
```

**預期輸出**應該包含：
```
CONTAINER ID   IMAGE                          STATUS         PORTS                    NAMES
xxx            sen-ba-li-18-docker-app:latest Up X minutes   0.0.0.0:5173->5173/tcp   sen-ba-li-18-dev
```

**檢查重點**：
- ✅ `STATUS` 應該是 `Up`
- ✅ `PORTS` 應該顯示 `0.0.0.0:5173->5173/tcp`（不是 `127.0.0.1:5173->5173/tcp`）

如果容器沒有運行，執行：
```bash
docker compose up -d
```

## 步驟 2：檢查容器日誌

查看容器日誌，確認 Vite 是否正常啟動：

```bash
docker logs sen-ba-li-18-dev
```

**預期輸出**應該包含：
```
VITE v7.x.x  ready in xxx ms

  ➜  Local:   http://localhost:5173/
  ➜  Network: http://172.x.x.x:5173/
```

如果看到錯誤訊息，請記錄下來。

## 步驟 3：檢查端口映射

確認端口是否正確映射到所有網路介面：

```bash
docker port sen-ba-li-18-dev
```

**預期輸出**：
```
5173/tcp -> 0.0.0.0:5173
```

如果顯示 `127.0.0.1:5173`，需要修改 `compose.yaml`。

## 步驟 4：從本機測試連線

在 Windows 上測試端口是否可訪問：

```cmd
# 方法一：使用 PowerShell
Test-NetConnection -ComputerName localhost -Port 5173

# 方法二：使用 curl（如果已安裝）
curl http://localhost:5173

# 方法三：在瀏覽器打開
# http://localhost:5173
```

如果本機無法訪問，問題可能在容器內部。

## 步驟 5：檢查防火牆設定

### Windows 防火牆檢查

1. **檢查防火牆規則**：
   ```cmd
   netsh advfirewall firewall show rule name="Docker Vite Dev Server"
   ```

2. **如果規則不存在，新增規則**（需要管理員權限）：
   ```cmd
   netsh advfirewall firewall add rule name="Docker Vite Dev Server" dir=in action=allow protocol=TCP localport=5173
   ```

3. **檢查 Docker Desktop 是否允許通過防火牆**：
   - 開啟「Windows 安全性」→「防火牆與網路保護」
   - 點選「允許應用程式通過防火牆」
   - 確認「Docker Desktop」已勾選「私人」和「公用」

### 臨時關閉防火牆測試（僅用於診斷）

⚠️ **警告**：僅用於診斷，測試完畢後請重新開啟防火牆。

```cmd
# 關閉防火牆（需要管理員權限）
netsh advfirewall set allprofiles state off

# 測試後重新開啟
netsh advfirewall set allprofiles state on
```

## 步驟 6：檢查網路連線

### 從 iPad 測試網路連線

在 iPad 上執行以下測試：

1. **確認 iPad 和電腦在同一網路**：
   - 檢查 iPad 的 Wi-Fi 設定
   - 確認連接到相同的 Wi-Fi 網路

2. **Ping 測試**（如果 iPad 有終端機應用）：
   ```bash
   ping 192.168.50.72
   ```

3. **嘗試其他端口**：
   如果 5173 被阻擋，可以嘗試修改端口（見下方解決方案）

## 步驟 7：檢查 Docker 網路設定

檢查容器的網路配置：

```bash
docker inspect sen-ba-li-18-dev | findstr "IPAddress"
```

或查看完整網路資訊：

```bash
docker inspect sen-ba-li-18-dev
```

查找 `NetworkSettings` → `Ports` 部分，確認端口映射。

## 常見問題與解決方案

### 問題 1：端口映射只綁定到 127.0.0.1

**症狀**：`docker ps` 顯示 `127.0.0.1:5173->5173/tcp`

**解決方案**：修改 `compose.yaml`，明確指定綁定到所有介面：

```yaml
ports:
  - "0.0.0.0:${VITE_DEV_PORT:-5173}:${VITE_DEV_PORT:-5173}"
```

然後重啟容器：
```bash
docker compose down
docker compose up -d
```

### 問題 2：防火牆阻擋

**症狀**：本機可以訪問，但區網無法訪問

**解決方案**：
1. 新增防火牆規則（見步驟 5）
2. 確認 Docker Desktop 允許通過防火牆

### 問題 3：Vite 未正確啟動

**症狀**：容器運行但日誌顯示錯誤

**解決方案**：
1. 檢查 `vite.config.ts` 中的 `host: "0.0.0.0"`
2. 檢查環境變數 `VITE_DEV_PORT` 是否正確
3. 重啟容器：
   ```bash
   docker compose restart
   ```

### 問題 4：端口被占用

**症狀**：容器無法啟動或端口映射失敗

**解決方案**：
1. 檢查端口占用：
   ```cmd
   netstat -ano | findstr :5173
   ```
2. 如果被占用，可以：
   - 關閉占用端口的程式
   - 或修改 `compose.yaml` 使用其他端口（如 5174）

### 問題 5：Docker Desktop 網路問題

**症狀**：所有檢查都正常，但無法連線

**解決方案**：
1. 重啟 Docker Desktop
2. 檢查 Docker Desktop 設定：
   - 開啟 Docker Desktop
   - 進入「Settings」→「Resources」→「Network」
   - 確認網路設定正確

## 快速修復命令

如果以上步驟都檢查過，可以嘗試以下快速修復：

```bash
# 1. 停止容器
docker compose down

# 2. 確認 compose.yaml 端口映射正確（應該是 0.0.0.0:5173:5173）

# 3. 重新啟動
docker compose up -d --build

# 4. 檢查狀態
docker ps
docker logs sen-ba-li-18-dev

# 5. 測試本機連線
curl http://localhost:5173
```

## 如果仍然無法解決

請提供以下資訊以便進一步診斷：

1. `docker ps` 的完整輸出
2. `docker logs sen-ba-li-18-dev` 的完整輸出
3. `docker port sen-ba-li-18-dev` 的輸出
4. Windows 防火牆規則列表
5. 從 iPad ping 192.168.50.72 的結果（如果可能）
