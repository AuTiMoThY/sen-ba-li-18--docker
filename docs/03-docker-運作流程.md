# Docker 運作流程

本文件說明 Docker 的整體運作流程，從構建到運行的完整生命週期。

## Docker 核心概念

在了解運作流程之前，先理解幾個核心概念：

- **映像檔（Image）**：只讀的模板，用於創建容器
- **容器（Container）**：映像檔的運行實例
- **Dockerfile**：定義如何構建映像檔的指令檔
- **Docker Compose**：用於定義和運行多容器應用程式的工具

## 完整運作流程

```
開發環境：
compose.yaml (target: development) 
  → Dockerfile (AS development) 
  → 運行 pnpm dev

生產環境：
compose.yaml (target: production) 
  → Dockerfile (AS production) 
  → 使用 build 階段的產物 (dist/)
  → nginx 提供靜態檔案
```

### 1. 構建階段（Build Phase）

當你執行 `docker compose build` 或 `docker compose up --build` 時：

```
┌─────────────────────────────────────────┐
│  1. 讀取 Dockerfile                     │
│     - 解析指令                          │
│     - 確定構建階段（target）            │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  2. 建立構建上下文（Build Context）     │
│     - 根據 .dockerignore 過濾檔案       │
│     - 準備要複製到容器的檔案            │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  3. 執行多階段構建                      │
│                                         │
│  ┌──────────────────────┐              │
│  │ deps 階段            │              │
│  │ - 安裝依賴           │              │
│  │ - 建立 node_modules  │              │
│  └──────────────────────┘              │
│              ↓                         │
│  ┌──────────────────────┐              │
│  │ development 階段      │              │
│  │ - 複製 node_modules   │              │
│  │ - 複製專案檔案        │              │
│  │ - 設定開發環境        │              │
│  └──────────────────────┘              │
│              ↓                         │
│  ┌──────────────────────┐              │
│  │ build 階段           │              │
│  │ - 複製 node_modules   │              │
│  │ - 複製專案檔案        │              │
│  │ - 執行構建命令        │              │
│  │ - 產生 dist/         │              │
│  └──────────────────────┘              │
│              ↓                         │
│  ┌──────────────────────┐              │
│  │ production 階段       │              │
│  │ - 使用 nginx 基礎映像 │              │
│  │ - 複製 dist/ 到 nginx │              │
│  └──────────────────────┘              │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  4. 建立映像檔層（Layers）               │
│     - 每個指令建立一個層                 │
│     - 層可以被快取和重用                │
│     - 最終映像檔包含所有層              │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  5. 標記映像檔（Tag）                    │
│     - 根據服務名稱和專案名稱標記        │
│     - 例如：sen-ba-li-18-docker-app     │
└─────────────────────────────────────────┘
```

### 2. 運行階段（Run Phase）

當你執行 `docker compose up` 時：

```
┌─────────────────────────────────────────┐
│  1. 讀取 compose.yaml                   │
│     - 解析服務定義                      │
│     - 檢查依賴關係                      │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  2. 檢查映像檔是否存在                   │
│     - 如果不存在，先執行構建            │
│     - 如果存在，使用現有映像檔          │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  3. 建立網路（Network）                 │
│     - 建立專案專用的網路                │
│     - 服務可以在網路上互相通訊          │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  4. 建立卷（Volumes）                   │
│     - 建立命名卷（如果有的話）          │
│     - 準備掛載點                        │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  5. 創建容器（Container）                │
│     - 從映像檔創建容器實例              │
│     - 設定環境變數                      │
│     - 設定端口映射                      │
│     - 掛載卷                            │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  6. 啟動容器                            │
│     - 執行 CMD 或 compose 中的 command  │
│     - 應用程式開始運行                  │
└─────────────────────────────────────────┘
```

### 3. 開發模式流程

在開發模式下，使用 volume 掛載實現熱重載：

```
┌─────────────────────────────────────────┐
│  主機檔案系統                            │
│  /project/src/App.vue  ←──┐            │
│  /project/package.json     │            │
└─────────────────────────────────────────┘
              │ 掛載（Volume）
              ↓
┌─────────────────────────────────────────┐
│  容器內部                                │
│  /app/src/App.vue  ←──┐                │
│  /app/package.json     │                │
│  /app/node_modules/    │（匿名卷，獨立） │
└─────────────────────────────────────────┘
              │
              ↓
┌─────────────────────────────────────────┐
│  開發伺服器（Vite）                      │
│  - 監聽檔案變更                          │
│  - 自動重新編譯                          │
│  - 熱模組替換（HMR）                     │
└─────────────────────────────────────────┘
              │
              ↓
┌─────────────────────────────────────────┐
│  瀏覽器                                  │
│  http://localhost:5173                  │
└─────────────────────────────────────────┘
```

### 4. 生產模式流程

在生產模式下，使用構建好的靜態檔案：

```
┌─────────────────────────────────────────┐
│  構建階段                                │
│  - 執行 pnpm run build                  │
│  - 產生 dist/ 目錄                      │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  生產映像檔（nginx）                     │
│  /usr/share/nginx/html/                 │
│    ├── index.html                       │
│    ├── assets/                          │
│    └── ...                              │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  運行容器                                │
│  - nginx 提供靜態檔案服務                │
│  - 監聽 80 端口                          │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  使用者請求                              │
│  http://localhost:80                    │
└─────────────────────────────────────────┘
```

## 層快取機制

Docker 使用層快取來加速構建：

```
指令執行順序：
1. FROM node:20-alpine          ← 快取層
2. RUN npm install -g pnpm      ← 快取層
3. COPY package.json ./         ← 檢查變更
   ├─ 如果 package.json 未變更 → 使用快取
   └─ 如果 package.json 變更   → 重新執行後續指令
4. RUN pnpm install             ← 可能使用快取
5. COPY . .                     ← 檢查變更
6. CMD ["pnpm", "dev"]          ← 快取層
```

**最佳實踐**：將不常變動的指令放在前面，常變動的指令放在後面。

## 容器生命週期

```
┌──────────┐
│ Created  │ ← docker create
└────┬─────┘
     │
     ↓
┌──────────┐
│ Running  │ ← docker start / docker compose up
└────┬─────┘
     │
     ├──→ ┌──────────┐
     │    │ Paused   │ ← docker pause
     │    └────┬─────┘
     │         │
     │         ↓
     │    ┌──────────┐
     │    │ Running  │ ← docker unpause
     │    └────┬─────┘
     │         │
     │         ↓
     ├──→ ┌──────────┐
     │    │ Stopped  │ ← docker stop / docker compose down
     │    └────┬─────┘
     │         │
     │         ↓
     └──→ ┌──────────┐
          │ Removed  │ ← docker rm
          └──────────┘
```

## 常用命令對應的流程

### `docker compose up --build`

```
1. 構建映像檔（如果 Dockerfile 或依賴變更）
2. 創建網路和卷
3. 創建並啟動容器
4. 附加到容器的輸出（日誌）
5. 完成後不會監控檔案變更
```

**特點**：
- 一次性構建並啟動
- 檔案變更後需要手動重建容器
- 適合初始啟動或重大變更後使用

### `docker compose watch`（推薦用於開發）

```
1. 構建映像檔（如果需要的話）
2. 創建網路和卷
3. 創建並啟動容器
4. 開始監控配置的檔案和目錄
5. 當檔案變更時：
   - sync: 同步檔案到容器（即時）
   - rebuild: 重建映像檔並重啟容器
   - sync+restart: 同步檔案並重啟容器
```

**特點**：
- 持續監控檔案變更
- 自動同步或重建，無需手動操作
- 適合開發環境，提供更好的開發體驗
- 需要 Docker Compose v2.22+ 和 compose.yaml 中的 `develop.watch` 配置

### `docker compose up -d`

```
1. 檢查映像檔是否存在
2. 創建網路和卷
3. 創建並啟動容器（背景執行）
4. 不附加輸出
```

**特點**：
- 背景執行，不阻塞終端
- 不會監控檔案變更
- 適合生產環境或不需要即時輸出的情況

### `docker compose down`

```
1. 停止所有容器
2. 移除容器
3. 移除網路（預設）
4. 不移除卷（預設，使用 -v 可移除）
```

### `docker compose logs -f`

```
1. 連接到容器的日誌輸出
2. 即時顯示新日誌（-f 參數）
```

## `docker compose watch` vs `docker compose up --build`

### 主要差異

| 特性 | `docker compose up --build` | `docker compose watch` |
|------|---------------------------|------------------------|
| **初始構建** | ✅ 構建並啟動 | ✅ 構建並啟動 |
| **檔案監控** | ❌ 不監控 | ✅ 持續監控 |
| **自動同步** | ❌ 需手動重建 | ✅ 自動同步/重建 |
| **開發體驗** | 一般 | 優秀 |
| **適用場景** | 初始啟動、重大變更 | 日常開發 |
| **Docker 版本** | 所有版本 | v2.22+ |

### 使用建議

**使用 `docker compose watch` 當：**
- 正在開發中，需要即時看到變更
- 想要自動同步檔案到容器
- 使用 Docker Compose v2.22 或更新版本

**使用 `docker compose up --build` 當：**
- 首次啟動專案
- 依賴（package.json）有重大變更
- 需要完全重建映像檔
- 使用較舊版本的 Docker Compose

### Watch 配置說明

在 `compose.yaml` 中配置 `develop.watch`：

```yaml
services:
  app:
    develop:
      watch:
        # sync: 即時同步檔案到容器（最快）
        - action: sync
          path: ./src
          target: /app/src
        
        # rebuild: 重建映像檔並重啟容器（用於依賴變更）
        - action: rebuild
          path: ./package.json
        
        # sync+restart: 同步檔案並重啟容器（用於配置變更）
        - action: sync+restart
          path: ./vite.config.ts
          target: /app/vite.config.ts
```

**Watch Actions 說明**：
- `sync`: 即時同步檔案到運行中的容器，無需重啟（最快）
- `rebuild`: 重建映像檔並重啟容器（用於需要重新構建的情況）
- `sync+restart`: 同步檔案後重啟容器（用於需要重啟才能生效的變更）

## 除錯流程

當遇到問題時，可以按照以下流程除錯：

```
1. 檢查容器狀態
   → docker compose ps

2. 查看容器日誌
   → docker compose logs app

3. 進入容器檢查
   → docker compose exec app sh

4. 檢查映像檔
   → docker images

5. 檢查網路
   → docker network ls

6. 檢查卷
   → docker volume ls
```

## 總結

Docker 的運作流程可以簡化為：

1. **定義**：透過 Dockerfile 定義映像檔
2. **構建**：從 Dockerfile 構建映像檔
3. **配置**：透過 compose.yaml 配置服務
4. **運行**：從映像檔創建並運行容器
5. **管理**：透過命令管理容器的生命週期

理解這個流程有助於更好地使用 Docker 和解決問題。
